
<%- include("../layout/customerside/header") %>
<%-include("../layout/customerside/navbar") %>

<style>
  .product-image-container {
    max-width: 100px; /* Set your desired max-width */
    overflow: hidden;
  }

  .product-image {
    width: 100%;
    height: auto;
  }
</style>
  <div class="site-wrap">
   
    <div class="bg-light py-3">
      <div class="container">
        <div class="row">
          <div class="col-md-12 mb-0"><a href="/">Home</a> <span class="mx-2 mb-0">/</span> <strong class="text-black">Checkout</strong></div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="site-section">
         <% if (!cartProducts.length) { %>
        Your cart is empty.
         <% } else { %>
        <div class="row">
            <% cartProducts.forEach((cartItem)=>{ %>
          <div class="col-md-12 p-4 border mb-3 d-flex">
            <div class="col-md-4">
              <a href="">
          
                <div class="product-image-container">
                  <!-- Resize the image using CSS -->
                  <img class="product-image" src="data:<%= cartItem.product.image[0].contentType %>;base64,<%= cartItem.product.image[0].data.toString('base64') %>">
                </div>
              </a>
            </div>
            <div class="col-md-4">
              <span class="d-block text-info h6 text-uppercase">
                 <%= cartItem.product.product_name %>
              </span>
              <p>
                   <%= cartItem.product.description %> <br>
                   Category: <%= cartItem.product.category.categoryName %> <br>
                
              </p>
              <% if (cartItem.product.offerPrice> 0 && cartItem.product.categoryOfferPrice > 0) { %>
                <% if(cartItem.product.offerPrice < cartItem.product.categoryOfferPrice){  %>
                  <span>&#8377;<%= cartItem.product.offerPrice %></span> <span><del class="text-danger"> <%=cartItem.product.price %> </del></span>
           <% }else{  %>
             

            <span>&#8377;<%= cartItem.product.categoryOfferPrice%></span>
         <span class="text-danger"><del class="text-danger">&#8377;<%=cartItem.product.price %></del></span>
            <% }%>

          <%}else if(cartItem.product.offerPrice>0){ %>
            <!-- Display offer price -->
              <span>&#8377;<%= cartItem.product.offerPrice %></span>
          <span class="text-danger"><del class="text-danger">&#8377; <%=cartItem.product.price %> </del></span>

         <% }else if(cartItem.product.categoryOfferPrice>0){  %>
          <!-- Display category offer price -->
        <span>&#8377;<%=cartItem.product.categoryOfferPrice%></span>
       <span class="text-danger"><del class="text-danger">&#8377;<%=cartItem.product.price %></del></span>

          <% }else{%>
            <!-- Display original price -->
           <span>&#8377;<%= cartItem.product.price%></span>
            <% }%>


              <p>
                Stock: <%= cartItem.product.stock_count %>
              </p>
            </div>
            <div class="col-md-4">
              <span class="text-black">
                Quantity: <%= cartItem.quantity %><br>
                Total Price: <span id="totalPrice_<%= cartItem._id %>" class="text-black">
                  <% if (cartItem.product.offerPrice > 0 && cartItem.product.categoryOfferPrice > 0) { %>
                    <% if(cartItem.product.offerPrice < cartItem.product.categoryOfferPrice){  %>
                      <span>&#8377;<%= cartItem.product.offerPrice * cartItem.quantity %></span> <span><del class="text-danger"> <%=cartItem.product.price*cartItem.quantity %> </del></span>
                    <% }else{  %>
                      <span>&#8377;<%= cartItem.product.categoryOfferPrice%></span>
                      <span class="text-danger"><del class="text-danger">&#8377;<%=cartItem.product.price * cartItem.quantity %></del></span>
                    <% } %>
                  <% } else if(cartItem.product.offerPrice>0){ %>
                    <!-- Display offer price -->
                    <span>&#8377;<%= cartItem.product.offerPrice * cartItem.quantity %></span>
                    <span class="text-danger"><del class="text-danger">&#8377; <%=cartItem.product.price * cartItem.quantity  %> </del></span>
                  <% } else if(cartItem.product.categoryOfferPrice>0){  %>
                    <!-- Display category offer price -->
                    <span>&#8377;<%=cartItem.product.categoryOfferPrice * cartItem.quantity%></span>
                    <span class="text-danger"><del class="text-danger">&#8377;<%=cartItem.product.price * cartItem.quantity%></del></span>
                  <% } else { %>
                    <!-- Display original price -->
                    <span>&#8377;<%= cartItem.product.price * cartItem.quantity%></span>
                  <% } %>
                  
                </span>
              </span>
            </div>
          </div>
          <% }) %>
        </div>

        <div class="row">
          <div class="col-md-6 mb-5">
            <div class="d-flex">
              <p class="m-3">
                <a href="/shop" class="btn btn-outline-secondary btn-sm btn-block">
                  Continue Shopping
                </a>
              </p>
              <p class="m-3">
                <a href="/cart" class="btn btn-secondary btn-sm btn-block">
                  Back To cart
                </a>
              </p>
            </div>
          </div>
          
          <form action="/user/checkout" method="post" id="checkout-form"onsubmit="return validateForm()" >
          <div class="col-md-12 address border p-3" id="checkoutAddressContainer" style="margin-right: 500px;width: 400px" >
            <div class="d-flex justify-content-between">
              <h4 class="text-black " style="font-weight: bold;" >Shipping Address</h4>
                      <% if(noOfaddress===0){ %>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
  
              <a href="/user/profile/add-address" class="btn btn-outline-secondary">
                Add New Address
              </a>
              <% } %>

            </div>
            <% if (addresses){ %>
              <% addresses.forEach((address) => { %>
                <div>
                  <input type="radio"  name="shippingAddress" value="<%= address._id %>">
                  <label>
                    <%= address.city %>, <%= address.pincode %>, <%= address.area %>, <%= address.building %>, <%= address.state %>
                  </label>
                </div>
              <% }) %>
            <% }else{ %>
            <p>No delivery address found.</p>
        <% } %>
          </div>
        </div>
         <% } %>
      </div>
    <div>
  

    </div>
     
        <div class="row">
          <div class="col-md-6 d-flex flex-column justify-content-between">
            <div>
              <div>
                <label class="text-black h4" for="payment">Payment Methods</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="method" value="rzp" checked>
                <label class="form-check-label" for="flexRadioDefault1">
                  Razorpay
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="method" value="wlt">
                <label class="form-check-label" for="flexRadioDefault2">
                  Wallet
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="method" value="cod">
                <label class="form-check-label" for="flexRadioDefault3">
                  Cash on Delivery
                </label>
              </div>
            </div>
          </div>
          <div class="col-md-6 pl-5">
            <div class="row justify-content-end">
              <div class="col-md-7">
                <div class="row">
                  <div class="col-md-12 text-right border-bottom mb-5">
                    <h3 class="text-black h4 text-uppercase">Price Details</h3>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <span>Price (<%= noOfItems %> items)</span>
                  </div>
                  <div class="col-md-6 pl-0">
                    <span class="text-black">
                      ₹<span id="totalPrice" class="text-black">
                        <%= grandTotal %>.00
                      </span>
                    </span>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <span>Delivery Charges</span>
                  </div>
                  <div class="col-md-6 pl-0">
                    <span class="text-black">
                      ₹<span class="text-black">
                        5.00
                      </span>
                    </span>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <span>Discount</span>
                  </div>
                  <div class="col-md-6 pl-0">
                    <span class="text-black">
                      <% if (discount===0) { %>
                      ₹<span class="text-black">
                        00.00
                      </span>
                      <% }else{ %>
                        ₹ <%= discount %>
                        <% } %>
                   
                    </span>
                  </div>
                </div>
                <div class="row mb-5">
                  <div class="col-md-6">
                    <span>Grand Total</span>
                  </div>
                  <div class="col-md-6 pl-0">
                    <span class="h5 text-black">
                      ₹<span id="grandTotalPrice" class="text-black">

                        <%=  (discount === 0 ? grandTotal + 5 : grandTotal - discount + 5)  %>
                        
                      </span>
                    </span>
                  </div>
                </div>
                <div class="row mb-5">
                  <div class="col-md-12">
                   
                   <% if  (!addresses.length){ %>
                    <p class="text-center">No Address found.</p>
                    <a href="/user/profile" class="btn btn-outline-dark btn-lg btn-block">
                      Go To Profile
                    </a>
                    <a href="/user/profile/add-address" class="btn btn-outline-secondary">
                      Add New Address
                    </a>
                    <%  }else { %>
                    <!-- <% console.log("addresses") %> -->

                    <div>
                      <input type="hidden" name="addressId" >
                      <input type="hidden" name="discount"  value="<%= discount %>">
                      <input type="hidden" name="currentCoupon" value="<%= currentCoupon %>" >
                      <button type="button" class="btn btn-secondary btn-lg py-3 btn-block" onclick="validateAndPlaceOrder()">Place Order</button>
                      
                      <p class="text-danger">
                        <%= error %>
                      </p>
                    </div>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    

      <div class="row col-lg-12">
        <form action="/apply-coupon" method="post" id="checkout-form" >
          <div>
            <div>
              <label class="text-black h4" for="coupon">Coupon</label>
              <p>Enter your coupon code if you have one.</p>
            </div>
            <div class="d-flex">
              <input type="text" class="form-control py-3" name="coupon" id="coupon" placeholder="Paste Coupon Code">
              <div class="col-md-4">
                <button type="submit" class="btn btn-dark btn-sm">Apply Coupon</button>
              </div>
            </div>
            <% if (couponError && couponError != undefined) { %>
              <p class="text-danger">
          <%= couponError %> 
              </p>
            <% } %>
            <a href="/coupons" class="btn btn-outline-dark btn-sm mt-4">View Available
              Coupons</a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Place Order Modal -->
  <div class="modal fade" id="placeOrderModal" tabindex="-1" role="dialog" aria-labelledby="placeOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="placeOrderModalLabel">Confirm Place Order</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          Are you sure you want to place your order?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-dark" id="confirmPlaceOrder" onclick="show()">Place Order</button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
  <script>
    function validateForm() {
      console.log("Validating form...");
      // Validate payment method
      var paymentMethod = document.querySelector('input[name="method"]:checked');
      if (!paymentMethod) {
        alert("Please choose a payment method");
        return false;
      }

      // Validate shipping address
      var shippingAddress = document.querySelector('input[name="shippingAddress"]:checked');
      console.log("shipping Address:",shippingAddress);
      if (!shippingAddress) {
        Swal.fire({
          icon: 'error',
          title: 'Oops...',
          text: 'Please choose a address.',
        });
        return
      }

      // If both validations pass, the form will be submitted
      return true;
    }
  </script>
<script>
  function validateAndPlaceOrder() {
      if (validateForm()) {
          openPlaceOrderModal();
      }
  }
</script>

  <script>
    function openPlaceOrderModal(){
      $('#placeOrderModal').modal('show')
    }
    // $('#confirmPlaceOrder').on('click',function(){
    //   console.log("Something");
      
    // })
    function show(){
      console.log("Something");
      const checkoutForm = document.getElementById('checkout-form')
      checkoutForm.submit()
      $('#placeOrderModal').modal('hide')
    }
  </script>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>



        <%- include("../layout/customerside/footer") %>