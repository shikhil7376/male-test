<%- include("../layout/customerside/header") %> <%-
include("../layout/customerside/navbar") %>
<!-- Header Section End -->
<!-- Breadcrumb Section Begin -->
<section class="breadcrumb-option">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="breadcrumb__text">
          <h4>Shop</h4>
          <div class="breadcrumb__links">
            <a href="./index.html">Home</a>
            <span>Shop</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- Breadcrumb Section End -->

<!-- Shop Section Begin -->
<section class="shop spad" id="shopSection">
  <div class="container">
    <div class="row">
      <div class="col-lg-3">
        <div class="shop__sidebar">
          <div class="shop__sidebar__search">
            <form class="search-model-form" method="get" action="/shop">
              <!-- Use the 'search' name for the input field -->
              <input
                type="text"
                class="form-control"
                name="search"
                value="<%= typeof query !== 'undefined' ? query : '' %>"
                placeholder="Search products"
              />
              <button type="submit"></button>
            </form>
          </div>
          <div class="shop__sidebar__accordion">
            <div class="accordion" id="accordionExample">
              <div class="card">
                <div class="card-heading">
                  <a data-toggle="collapse" data-target="#collapseOne"
                    >Categories</a
                  >
                </div>
                <div
                  id="collapseOne"
                  class="collapse show"
                  data-parent="#accordionExample"
                >
                  <div class="card-body">
                    <div class="shop__sidebar__categories">
                      <% categoryDatas.forEach((category)=>{ %>
                      <ul class="nice-scroll">
                        <li>
                     <a style=" color: #b7b7b7 " href="/shop?category=<%=category._id %>"
                            ><%= category.categoryName %></a>
                          
                        </li>
                        <% }) %>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card">
                <div class="card-heading">
                  <a data-toggle="collapse" data-target="#collapseTwo"
                    >Branding</a
                  >
                </div>
                <div
                  id="collapseTwo"
                  class="collapse show"
                  data-parent="#accordionExample"
                >
                  <div class="card-body">
                    <div class="shop__sidebar__brand">
                      <% productDatas.forEach((element)=>{ %>
                      <ul>
                        <li>
                          <h5 style=" color: #b7b7b7; font-size:medium; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;"
                            onclick="fetchProduct('<%= element.brand_name %>')"
                          >
                            <%= element.brand_name %>
                        </h5>
                        </li>
                        <%}) %>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card">
                <div class="card-heading">
                  <a data-toggle="collapse" data-target="#collapseThree"
                    >Filter Price</a
                  >
                </div>
                <div
                  id="collapseThree"
                  class="collapse show"
                  data-parent="#accordionExample"
                >
                  <div class="card-body">
                    <div class="shop__sidebar__price">
                      <ul>
                        <li>
                          <a href="/shop?minPrice=0&maxPrice=500"
                            >₹0.00 - ₹500.00</a
                          >
                        </li>
                        <li>
                          <a href="/shop?minPrice=500&maxPrice=1000"
                            >₹500.00 - ₹1000.00</a
                          >
                        </li>
                        <li>
                          <a href="/shop?minPrice=1000&maxPrice=1500"
                            >₹1000.00 - ₹1500.00</a
                          >
                        </li>
                        <li>
                          <a href="/shop?minPrice=1500&maxPrice=2000"
                            >₹1500.00 - ₹2000.00</a
                          >
                        </li>
                        <li>
                          <a href="/shop?minPrice=2000&maxPrice=2500"
                            >₹2000.00 - ₹2500.00</a
                          >
                        </li>
                        <li><a href="/shop?minPrice=2500">₹2500.00+</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
             
           
              <div class="card">
                <div class="card-heading">
                  
                </div>
                <div
                  id="collapseSix"
                  class="collapse show"
                  data-parent="#accordionExample"
                >
                  <div class="card-body">
                    
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-9">
        <div class="shop__product__option">
          <div class="row">
            <div class="col-lg-6 col-md-6 col-sm-6">
              <div class="shop__product__option__left">
                <p>Showing 1–12 of 126 results</p>
              </div>
            </div>
            <div class="col-lg-6 col-md-6 col-sm-6">
              <div class="shop__product__option__right">
               
              </div>
            </div>
          </div>
        </div>
        <div class="row" id="product_div">
          <!-- <div class="col-md-12 d-flex"> -->
          <% if(!productDatas.length){ %> No products found <% }else{ %> <%
          productDatas.forEach((element)=>{ %>
          <div class="col-lg-4 col-md-6 col-12 product__item">
            <div class="product__item__pic set-bg">
              <a href="/single/<%= element._id %>">
                <img
                  style="height: 260px ;width: 260px;"
                  src="data:<%= element.image[0].contentType %>;base64,<%= element.image[0].data.toString('base64') %>"
                />
              </a>
              
            </div>
            <div class="product__item__text">
         <h5 style="font-size: small; font-weight: 500; text-transform: uppercase; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;"><%= element.product_name %></h5> 
            

              <div class="rating">
                <i class="fa fa-star-o"></i>
                <i class="fa fa-star-o"></i>
                <i class="fa fa-star-o"></i>
                <i class="fa fa-star-o"></i>
                <i class="fa fa-star-o"></i>
              </div>
              <% if (element.offerPrice> 0 && element.categoryOfferPrice > 0) { %>
                      <% if(element.offerPrice < element.categoryOfferPrice){  %>
                        <span>&#8377;<%= element.offerPrice %></span> <span><del class="text-danger"> <%=element.price %> </del></span>
                 <% }else{  %>
                   

                  <span>&#8377;<%= element.categoryOfferPrice%></span>
               <span class="text-danger"><del class="text-danger">&#8377;<%=element.price %></del></span>
                  <% }%>

                <%}else if(element.offerPrice>0){ %>
                  <!-- Display offer price -->
                    <span>&#8377;<%= element.offerPrice %></span>
                <span class="text-danger"><del class="text-danger">&#8377; <%=element.price %> </del></span>

               <% }else if(element.categoryOfferPrice>0){  %>
                <!-- Display category offer price -->
              <span>&#8377;<%=element.categoryOfferPrice%></span>
             <span class="text-danger"><del class="text-danger">&#8377;<%=element.price %></del></span>

                <% }else{%>
                  <!-- Display original price -->
                 <span style="font-weight: 500;">&#8377;<%= element.price%></span>
                  <% }%>
            </div>
          </div>

          <% }) %>
        </div>
        <% } %>

        <div class="row">
          <div class="col-lg-12">
            <div class=n "product__pagination"> <% if(!categoryBased){ %> <%
            if(currentPage>1){ %>
            <a class="active" href="/shop/<%= currentPage - 1 %>">&lt---</a>
            <% } %> <% for(let i=1;i<= totalPages;i++){ %> <% if(i===
            currentPage){ %>
            <a href="/shop/<%= i %>"> <%= i %> </a>
            <% } %> <% } %> <% if(currentPage < totalPages){ %>
            <a href="/shop/<%= currentPage + 1 %>">---&gt;</a>

            <% } %> <% } %>
          </div>
        </div>
        <!-- </div> -->
      </div>
    </div>
  </div>
</section>
<!-- Shop Section End -->
<script>
  function fetchProduct(brand) {
    fetch(`http://localhost:8000/shop?brand=${encodeURIComponent(brand)}`, {
      method: "GET",
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        const products = data.prod;

        const container = document.getElementById("product_div");
        container.innerHTML = "";

        products.forEach((element) => {
          const productContainer = document.createElement("div");
          productContainer.classList.add(
            "col-lg-4",
            "col-md-6",
            "col-12",
            "product__item"
          );

          const productImage = document.createElement("div");
          productImage.classList.add("product__item__pic", "set-bg");
          const imageLink = document.createElement("a");
          imageLink.href = `/single/${element._id}`;
          const image = document.createElement("img");

          // Convert Buffer to base64 and set as src
          const bufferData = new Uint8Array(element.image[0].data.data);
          const blob = new Blob([bufferData], {
            type: element.image[0].contentType,
          });
          const reader = new FileReader();

          reader.onloadend = function () {
            const imageDataBase64 = reader.result.split(",")[1];
            const imageData = `data:${element.image[0].contentType};base64,${imageDataBase64}`;
            image.src = imageData;
            console.log(image.src);
          };

          reader.readAsDataURL(blob);

          imageLink.appendChild(image);
          productImage.appendChild(imageLink);
          productContainer.appendChild(productImage);

          const productText = document.createElement("div");
          productText.classList.add("product__item__text");
          const productName = document.createElement("h6");
          productName.textContent = element.product_name;
          const addToCartLink = document.createElement("a");
          addToCartLink.href = "#";
          addToCartLink.classList.add("add-cart");
          addToCartLink.textContent = "+ Add To Cart";
          const productRating = document.createElement("div");
          productRating.classList.add("rating");
          const productPrice = document.createElement("h5");
          productPrice.textContent = `₹${element.price}`;

          productText.appendChild(productName);
          productText.appendChild(addToCartLink);
          productText.appendChild(productRating);
          productText.appendChild(productPrice);

          productContainer.appendChild(productText);
          container.appendChild(productContainer);
        });
      })
      
      .catch((error) => console.error("Fetch error:", error));
  }
</script>

<!-- Footer Section Begin -->
<%- include("../layout/customerside/footer") %>
